<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OfertMatch — Lista de Produtos</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>

<!-- MENU LATERAL -->
<nav class="menu-lateral" id="menuLateral" role="navigation" aria-label="Menu lateral">
  <img src="img/Logo_Menor.png" alt="OfertMatch" class="logo_menu"/>
  <ul>
    <li><a href="index.html"><img src="img/icon_home.png" class="icons_menu"><span>Início</span></a></li>
    <li><a href="lista_produtos.html" class="active"><img src="img/icon_lista_produtos.png" class="icons_menu"><span>Lista de Produtos</span></a></li>
    <li><a href="lista_ofertas.html"><img src="img/icon_lista_produtos.png" class="icons_menu"><span>Lista de Ofertas</span></a></li>
    <li><a href="promocao.html"><img src="img/icon_promocao.png" class="icons_menu"><span>Inserir Promoção</span></a></li>
    <li><a href="endereco.html"><img src="img/icon_localizacao.png" class="icons_menu"><span>Endereço</span></a></li>
    <li><a href="sobre.html"><img src="img/icon_sobre.png" class="icons_menu"><span>Sobre</span></a></li>
    <li><a href="contato.html"><img src="img/icon_contato.png" class="icons_menu"><span>Contato</span></a></li>
  </ul>
</nav>
<div class="overlay" id="overlay" aria-hidden="true"></div>

<header>
  <button id="btnMenu" aria-controls="menuLateral" aria-expanded="false" aria-label="Abrir menu lateral">☰</button>
  <img src="img/Logo_Menor.png" alt="OfertMatch" class="logo"/>
  <span id="api-status" style="font-size:14px;opacity:.8"></span>
</header>

<main class="listas">
  <h2>Lista de Produtos</h2>

  <div class="lista-controles" style="gap:8px;flex-wrap:wrap">
    <input id="busca" type="search" placeholder="Buscar por nome, código, categoria, marca…" style="flex:1;min-width:220px;height:36px;padding:0 10px;border-radius:8px;border:1px solid #e6e6e6;background:#eef0f3;outline:none">
    <button id="btnBuscar">Buscar</button>
    <button id="btnLimpar">Limpar</button>
  </div>

  <div class="box-lista">
    <table class="om-table">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Código</th>
          <th>Estoque</th>
          <th>Categoria</th>
          <th>Marca</th>
          <th>Valor</th>
          <th>Validade</th>
          <th style="width:120px">Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyProdutos"></tbody>
    </table>
  </div>

  <div id="paginacao" style="display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px">
    <button id="prev">◀</button>
    <span id="pageInfo" style="font-weight:600"></span>
    <button id="next">▶</button>
  </div>
</main>

<div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script>
/* ===== config & utils iguais ao seu projeto ===== */
const BASE_URL = "https://ofertmatch.onrender.com";
const ENDPOINTS = { produtos: `${BASE_URL}/api/produtos`, health: `${BASE_URL}/api/health` };

const btnMenu = document.getElementById("btnMenu");
const menuLateral = document.getElementById("menuLateral");
const overlay = document.getElementById("overlay");
let menuAberto=false;
function abrirMenu(){ menuLateral.style.left = "0"; overlay.style.display = "block"; btnMenu?.setAttribute("aria-expanded","true"); menuAberto = true; }
function fecharMenu(){ menuLateral.style.left = "-250px"; overlay.style.display = "none"; btnMenu?.setAttribute("aria-expanded","false"); menuAberto = false; }
btnMenu?.addEventListener("click", ()=> menuAberto? fecharMenu(): abrirMenu());
overlay?.addEventListener("click", fecharMenu);
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && menuAberto){ fecharMenu(); btnMenu?.focus(); }});

function mostrarToast(msg, tipo="sucesso"){
  const t=document.getElementById("toast"); if(!t) return;
  t.className="toast"; t.classList.add(tipo); t.textContent=msg; t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"), 2800);
}
function withTimeout(ms=20000){ const c=new AbortController(); const id=setTimeout(()=>c.abort("timeout"),ms); return {signal:c.signal,cancel:()=>clearTimeout(id)};}
async function apiGet(url){
  const t=withTimeout();
  try{
    const r=await fetch(url,{cache:"no-store",signal:t.signal});
    const j=await r.json();
    if(!r.ok||j.ok===false) throw new Error(j.msg||`Erro HTTP ${r.status}`);
    return j;
  }catch(e){
    console.error(e); mostrarToast(e?.name==="AbortError"?"Tempo esgotado (20s).":(e.message||"Falha de conexão."),"erro"); return {ok:false,data:[]};
  }finally{ t.cancel(); }
}
async function apiDelete(url){
  const t=withTimeout();
  try{
    const r=await fetch(url,{method:"DELETE",signal:t.signal});
    const j=await r.json();
    if(!r.ok||j.ok===false) throw new Error(j.msg||`Erro HTTP ${r.status}`);
    return j;
  }catch(e){ console.error(e); mostrarToast(e?.name==="AbortError"?"Tempo esgotado (20s).":(e.message||"Falha ao excluir."),"erro"); return null; }
  finally{ t.cancel(); }
}
async function checkApi(){
  const el=document.getElementById("api-status"); if(!el) return;
  try{ const r=await apiGet(ENDPOINTS.health); el.textContent = r?.ok ? "API online ✅" : "API respondeu, verifique"; }
  catch{ el.textContent="API offline ⏳"; }
}
document.addEventListener("DOMContentLoaded", checkApi);

/* ===== listagem com busca + paginação ===== */
let page=1, limit=10, total=0, q="";
const tbody=document.getElementById("tbodyProdutos");
const pageInfo=document.getElementById("pageInfo");

function fmtMoney(v){ if(v==null) return ""; const n=Number(v); if(Number.isNaN(n)) return v; return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}); }

async function carregar(){
  const url = `${ENDPOINTS.produtos}?page=${page}&limit=${limit}${q?`&q=${encodeURIComponent(q)}`:""}`;
  const res = await apiGet(url);
  const data = res?.data || [];
  total = res?.pagination?.total || data.length;

  tbody.innerHTML = "";
  data.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${p.nome??""}</td>
      <td>${p.codigo??""}</td>
      <td>${p.estoque??""}</td>
      <td>${p.categoria??""}</td>
      <td>${p.marca??""}</td>
      <td>${fmtMoney(p.valor)}</td>
      <td>${p.validade??""}</td>
      <td>
        <button class="btn-del" data-id="${p._id}">Excluir</button>
      </td>`;
    tbody.appendChild(tr);
  });

  document.querySelectorAll(".btn-del").forEach(b=>{
    b.onclick = async ()=>{
      if(!confirm("Excluir este produto?")) return;
      const ok = await apiDelete(`${ENDPOINTS.produtos}/${b.dataset.id}`);
      if(ok && ok.ok){ mostrarToast("Produto excluído!", "sucesso"); carregar(); }
    };
  });

  const totalPages = Math.max(1, Math.ceil(total/limit));
  pageInfo.textContent = `Página ${page} de ${totalPages}`;
  document.getElementById("prev").disabled = (page<=1);
  document.getElementById("next").disabled = (page>=totalPages);
}
document.getElementById("prev").onclick = ()=>{ if(page>1){ page--; carregar(); } };
document.getElementById("next").onclick = ()=>{ page++; carregar(); };

document.getElementById("btnBuscar").onclick = ()=>{ q=document.getElementById("busca").value.trim(); page=1; carregar(); };
document.getElementById("btnLimpar").onclick = ()=>{ document.getElementById("busca").value=""; q=""; page=1; carregar(); };

document.addEventListener("DOMContentLoaded", carregar);
</script>
</body>
</html>
